<!DOCTYPE html>
<html>


<head>

    <title>After School Club</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="lessons.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

</head>

<body>



    <div id="app">
        <header>
            <h1>After School Club</h1>
            <button @click="switchView()" v-bind:disabled="cartItemCount<1">
                {{cartItemCount}}
                <span class="fas fa-cart-plus"></span>
                Checkout
            </button>
        </header>
        <br>
        <div id="shopping" v-if="showLessons">
                <input type="text" v-model="searchInput" @keyup="searchResultArray" placeholder="Search lessons">
                <button v-on:click="searchResultArray">Search</button>
            <div class="sortedBy">sorted by
                <select class="sortingFont" v-model="filter">
                    <option value="subject">Subject</option>
                    <option value="location">Location</option>
                    <option value="price">Price</option>
                    <option value="space">Space</option>
                </select>

                <input type="radio" id="asc" value="ascending" v-model="sortDirection">
                <label for="ascending">Ascending</label>
                <input type="radio" id="desc" value="descending" v-model="sortDirection">
                <label for="descending">Descending</label>
            </div>
            <br><br>
            <div v-for="lesson in sortedLessons">
                <img v-bind:src="lesson.image" height="150">
                <h2>{{lesson.subject}}</h1>
                    <p>Location: {{lesson.location}}</p>
                    <p>Price: {{lesson.price}}</p>
                    <p>Spaces: {{lesson.availableInventory - getItemCount(lesson.id)}}</p>
                    <!-- <p>{{getNestedList}}</p> -->
                    <button @click="addToCart(lesson.id)" v-bind:disabled="!canAddToCart(lesson)">Add to
                        cart</button>
                    <br><br>
            </div>
        </div>
        <div v-else>
            <h2>Checkout</h2>
            <div v-for="item in getNestedList">
                <div v-for="lesson in sortedLessons">
                    <span v-if="item.id === lesson.id && item.amountInCart >= 1">
                        <!-- <img v-bind:src="lesson.image" height="150"> -->
                        <h2>{{lesson.subject}}</h1>
                            <p>Location: {{lesson.location}}</p>
                            <p>Price: {{lesson.price}}</p>
                            <p>Quantity: {{item.amountInCart}}</p>
                            <button @click="removeFromCart(lesson.id)">Remove from cart</button>
                            <p>------</p>
                    </span>
                    <span v-else></span>
                </div>
            </div>
            <div>
                <strong>Full Name: </strong>
                <input type="text" v-model="order.fullName">
                <strong>Phone Number: </strong>
                <input v-model="order.phone">
                <button @click="completeCheckout()" v-bind:disabled="!this.canCheckout">Checkout</button>
            </div>
        </div>
    </div>

    <script>

        const sorters = {
            subject_ascending: (a, b) => {
                let x = a.subject.toUpperCase(),
                    y = b.subject.toUpperCase();
                return x == y ? 0 : x > y ? 1 : -1;
            },
            subject_descending: (a, b) => {
                let x = a.subject.toUpperCase(),
                    y = b.subject.toUpperCase();
                return x == y ? 0 : x > y ? -1 : 1;
            },

            location_ascending: (a, b) => {
                let x = a.location.toUpperCase(),
                    y = b.location.toUpperCase();
                return x == y ? 0 : x > y ? 1 : -1;
            },
            location_descending: (a, b) => {
                let x = a.location.toUpperCase(),
                    y = b.location.toUpperCase();
                return x == y ? 0 : x > y ? -1 : 1;
            },

            price_ascending: (a, b) => a.price - b.price,
            price_descending: (a, b) => b.price - a.price,

            space_ascending: (a, b) => a.space - b.space,
            space_descending: (a, b) => b.space - a.space,
        };
        let app = new Vue({

            el: '#app',
            data: {
                showLessons: true,
                lessons: lessons,
                cart: [],
                filter: "price",
                sortDirection: "ascending",
                order: {
                    fullName: "",
                    phone: "",
                    total: "",
                },
                searchInput: ""
            },
            methods: {
                addToCart(id) {
                    this.cart.push(id);
                },
                canAddToCart(lesson) {
                    let id = lesson.id;
                    let itemCount = this.getItemCount(id);
                    let spaces = lesson.availableInventory;
                    return spaces > itemCount;
                },
                getItemCount(id) {
                    let counter = 0;
                    for (i = 0; i < this.cart.length; i++) {
                        if (this.cart[i] === id) {
                            counter++;
                        }
                    }
                    return counter;
                },  
                sortBy(attribute) {
                    function compare(a, b) {
                        if (a.subject > b.subject) return 1;
                        if (a.subject < b.subject) return -1;
                        return 0;
                    }
                    return this.lessons.sort(compare);
                },
                removeFromCart(id){
                    const index = this.cart.indexOf(id);
                    if (index > -1) {
                        this.cart.splice(index, 1);
                    }
                    if(this.cart.length === 0){
                        this.switchView();
                    }
                },   
                switchView() {
                    this.showLessons = this.showLessons ? false : true;
                },
                completeCheckout(){
                    alert("Checkout Complete");
                }, 
            },
            computed: {
                cartItemCount() {
                    return this.cart.length;
                },
                searchResultArray(){
                    return this.lessons.filter(el => el.subject.includes(this.searchInput) || el.location.includes(this.searchInput));
                },
                sortedLessons() {
                    return this.searchResultArray.slice().sort(sorters[this.filter + "_" + this.sortDirection]);
                },
                getAllItemIds() {
                    let ids = [];
                    for (i = 0; i < lessons.length; i++) {
                        ids.push(lessons[i].id);
                    }
                    return ids;
                },
                getNestedList() {
                    let ids = this.getAllItemIds;
                    let result = [];
                    for (i = 0; i < ids.length; i++) {
                        let counter = 0;
                        for (j = 0; j < this.cart.length; j++) {
                            if (ids[i] === this.cart[j]) {
                                counter++;
                            }
                        }
                        result.push({
                            id: ids[i],
                            amountInCart: counter
                        });
                    }
                    return result;
                },
                canCheckout(){
                    if (/^[a-zA-Z]+$/.test(this.order.fullName) && /^\d+$/.test(this.order.phone)){
                        return true;
                    } else {
                        return false;
                    }
                },
            }

        });

    </script>

</body>

</html>